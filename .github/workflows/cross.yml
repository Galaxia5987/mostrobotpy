---
name: cross

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch or tag to build'
        required: true
        default: 'good_version'

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:
  cross-meson:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        os: [wpilib/raspbian-cross-ubuntu:2025-bookworm-24.04-py310]
        

    container:
      image: "${{ matrix.os.container }}"

    steps:
    - name: Resolve ref
      id: ref
      run: |
        INPUT_REF="${{ github.event.inputs.ref }}"
        # strip leading refs/ if user entered a full ref
        CLEAN_REF="${INPUT_REF#refs/heads/}"
        CLEAN_REF="${CLEAN_REF#refs/tags/}"
        echo "ref_name=$CLEAN_REF" >> $GITHUB_OUTPUT

    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ steps.ref.outputs.ref_name }}

    - name: Setup cross environment for meson
      uses: robotpy/build-actions/setup-cross-meson@semiwrap

    - run: apt-get update

    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: ${{ matrix.os.container }}
        variant: ccache

    - name: Install deps
      shell: bash
      run: |
        /build/venv/bin/cross-pip --disable-pip-version-check install -r rdev_requirements.txt

    - name: Build wheels
      shell: bash
      run: |
        /build/venv/bin/cross-python -m devtools ci build-meson-wheels --no-test --cross=cross.txt

    - uses: actions/upload-artifact@v4
      with:
        name: cross-meson-${{ matrix.os.name }}
        path: dist
